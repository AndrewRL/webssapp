{% extends "base.html" %}

{% block containedcontent %}

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th> Employee Name </th>
            {# date labels #}
            {% for d in range(7) %}
            <th id="date-{{ d }}"></th>
            {% endfor %}
        </tr>
    </thead>
    <tbody id="pref-table-body">
    </tbody>
</table>

<!-- Preference modal -->
<div class="modal fade" id="preference-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="preference-modal-title">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="preference-modal-body">
          <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="available-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  ...
              </button>
              <div class="dropdown-menu" aria-labelledby="available-dropdown">
                <a class="dropdown-item available-dropdown-select" href="#" data-text="Available" data-val=true>Available</a>
                <a class="dropdown-item available-dropdown-select" href="#" data-text="Unavailable" data-val=false>Unavailable</a>
              </div>
            </div>

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Start time</th>
                        <th>End time</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="preference-table">
                </tbody>
            </table>

            <button class="btn btn-warning" type="button" id="add-availability-button">Add availability</button>
          
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-pref-button" data-dismiss="modal">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Add employee modal -->
<div class="modal fade" id="add-employee-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="add-employee-modal-title">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="add-employee-modal-body">
          <div class="form-group">
              <label for="name-input">Employee Name</label>
              <input type="text" class="form-control" id="add-employee-name-input" placeholder="Employee Name">
          </div>
          
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="add-employee-submit" data-dismiss="modal">Save</button>
      </div>
    </div>
  </div>
</div>


<button class="btn btn-primary" data-toggle="modal" data-target="#add-employee-modal">Add Employee</button>

{% endblock containedcontent %}

{% block js %}
<script>
let initial_day = {{ date_ordinal }};

function refresh_table() {
    fetch("/_get_preferences/" + initial_day)
        .then(response => response.json())
        .then((json_pref_table) => {
            console.log(json_pref_table);
            set_dates(json_pref_table.dates);
            render_pref_table(json_pref_table.pref_table, json_pref_table.dates, json_pref_table.employees);
    });
}

refresh_table();

$(".available-dropdown-select").on("click", function () {
    $("#available-dropdown").data("available", $(this).data("val"))
        .text($(this).data("text"));
});

$("#add-employee-submit").on("click", function() {
    console.log("hi");
    $.ajax({
        type: "POST",
        url: "/_add_employee",
        data: {name: $("#add-employee-name-input").val()},
        success: function(json_response) {
            console.log(json_response);
        }
    });
    refresh_table();
});



function set_dates(dates) {
    for (d = 0; d < 7; d++) {
        $("#date-" + d).text(dates[d]);
    }
}

function hour_to_12_hour(h) {
    if (h == 0) {
        return {hour: 12, half: "AM"};
    }
    else if (h < 12) {
        return {hour: h, half: "AM"};
    }
    else if (h == 12) {
        return {hour: 12, half: "PM"};
    }
    else {
        return {hour: h - 12, half: "PM"};
    }
}

function hour_to_24_hour(h) {
    let offset = h.half == "AM" ? 0 : 12;
    if (h.hour == 12 && h.half == "AM") {
        offset = -12;
    }
    else if (h.hour == 12 && h.half == "PM") {
        offset = 0;
    }
    return h.hour + offset;
}

function hour_to_str(h) {
    let t = hour_to_12_hour(h);
    return t.hour + t.half;
}

/*
        {% for employee in employees %}
            {% set employee_loop = loop %}
        <tr id="employee-row-{{ employee._id }}">
            <th scope="row"><button type="button" class="btn btn-primary"> {{ employee.name }} </th>
            {% for d in range(7) %}
            <td class="employee-pref-box-{{ d }}">
                <button class="btn" data-toggle="modal" data-target="#preference-modal"></button>
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
*/

function render_pref_table(pref_table, dates, employees) {
    $("#pref-table-body").empty();
    for (let employee_id in pref_table) {
        console.log(employee_id);

        let emp_row = document.createElement("tr");
        $("#pref-table-body").append(emp_row);
        let emp_name = $("<th/>", { scope: "row" });
        emp_row.append(emp_name[0]);
        emp_name.append($("<button/>", {
            type: "button",
            class: "btn btn-primary",
            text: employees[employee_id].name,
        })[0]);

        for (let [day, shift] of pref_table[employee_id].entries()) {
            let td = $("<td/>");
            emp_row.append(td[0]);

            if (shift.available) {
                var btn_text = hour_to_str(shift.prefs[0][0]) + " - " + hour_to_str(shift.prefs[0][1]);
                if (shift.prefs.length > 1) {
                    btn_text += ", ...";
                }
                var btn_class = "btn-info";
            }
            else {
                var btn_text = "Add availability";
                var btn_class = "btn-light";
            }

            td.append($("<button/>", {
                class: "btn " + btn_class,
                "data-toggle": "modal",
                "data-target": "#preference-modal",
                text: btn_text,
            }).click(function() {
                // note the modal get's opened anyway, just need
                // to modify the info in it
                open_pref_modal(employee_id, day, this);
            }));
        }
    }

    function open_pref_modal(employee_id, day, button_element) {
        let employee_data = pref_table[employee_id][day];
        let available = employee_data.available;

        $("#preference-modal-title").html("<strong>" + employees[employee_id].name + "</strong>: " + dates[day]);

        $("#available-dropdown").text(available ? "Available" : "Unavailable")
            .data("available", available);

        $("#preference-table").empty();
        for (let pref of employee_data.prefs) {
            create_availability_row(pref);
        }

        $("#save-pref-button").off("click").on("click", function() {
            // get the new pref data
            let new_pref = [];
            $("#preference-table").children().each((row_index, row) => {
                let tds = $(row).children();
                let start_time_selects = $(tds[0]).find("select");
                let start_hour = hour_to_24_hour({hour: parseInt($(start_time_selects[0]).val()),
                                                  half: $(start_time_selects[1]).val()});
                let end_time_selects = $(tds[1]).find("select");
                let end_hour = hour_to_24_hour({hour: parseInt($(end_time_selects[0]).val()),
                                                half: $(end_time_selects[1]).val()});

                new_pref.push([start_hour, end_hour]);
            });

            let available = $("#available-dropdown").data("available");

            pref_table[employee_id][day] = {
                prefs: new_pref,
                available: available
            }
            render_pref_table(pref_table, dates, employees);
        });
    }
}

$("#add-availability-button").on("click", function() {
    create_availability_row([0, 1]);
});

function create_availability_row(pref) {
    let pref_row = document.createElement("tr");
    let remove_button = document.createElement("button");
    $(remove_button).addClass("btn btn-danger")
        .text("Remove")
        .on("click", function () {
            pref_row.remove();
        });

    for (let [s, hour_type] of ["start", "end"].entries()) {
        let hour_select = document.createElement("select");
        let t = hour_to_12_hour(pref[s]);
        for (let hour = 1; hour < 13; hour++) {
            $(hour_select).append("<option value="+hour+">"+hour+"</option>");
        }
        $(hour_select).addClass("form-control")
            .val(t.hour);
        let half_select = document.createElement("select");
        $(half_select).addClass("form-control")
            .append('<option value="AM">AM</option>')
            .append('<option value="PM">PM</option>')
            .val(t.half);
        let td = document.createElement("td");
        let div = document.createElement("div");
        $(div).addClass("form-row");
        [hour_select, half_select].forEach(elem => {
            let col = document.createElement("div");
            $(col).addClass("col")
                .append(elem);
            $(div).append(col);
        });
        $(td).append(div);
        $(pref_row).append(td);
    }
    
    $(pref_row).append(remove_button);

    $("#preference-table").append(pref_row);
}

    


</script>
{% endblock js %}


